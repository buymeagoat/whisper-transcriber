name: CI
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          cd frontend && npm install
      - name: Lint
        run: |
          black --check .
          cd frontend && npm run lint
      - name: Test
        run: |
          scripts/run_tests.sh
          echo "RESULTS=passed" >> $GITHUB_ENV
      - name: Build
        run: |
          scripts/whisper_build.sh
          echo "BUILD_ID=${{ github.run_id }}" >> $GITHUB_ENV
      - name: Verify required logs exist
        run: |
          test -f docs/CHANGELOG.md
          test -n "$(ls -1 logs/changes/change_*.md 2>/dev/null | tail -n1)"
          test -n "$(ls -1 logs/builds/build_*.md 2>/dev/null | tail -n1)"
      - name: Finalize build summary
        run: |
          LATEST=$(ls -1 logs/builds/build_*.md | tail -n1)
          {
            echo ""
            echo "## CI Summary"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "- Tests: $RESULTS"
            echo "- Build ID: $BUILD_ID"
          } >> "$LATEST"
      - name: Upload raw logs (optional)
        uses: actions/upload-artifact@v4
        with:
          name: raw-logs
          path: |
            **/test-results/**
            **/build-logs/**

      - name: Security Validation
        run: |
          scripts/validate_production_security.sh
        env:
          ENVIRONMENT: production
