<!DOCTYPE html>
<html>
<head>
    <title>Transcription Status</title>
    {% if not state.startswith("Cancelled") and not done and not error %}
		<meta http-equiv="refresh" content="5">
	{% endif %}
    <style>
        pre#log {
            background: #f0f0f0;
            padding: 10px;
            max-height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
        }
        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .progress-bar {
            height: 20px;
            background-color: #4caf50;
            width: 0%;
            color: white;
            text-align: center;
            border-radius: 5px;
        }
        #cancelButton {
            margin-top: 10px;
        }
        #cancelStatus {
            margin-top: 5px;
            font-style: italic;
            color: darkred;
        }
    </style>
    <script>
        window.onload = function () {
            const logBox = document.getElementById("log");
            if (logBox) logBox.scrollTop = logBox.scrollHeight;
        };

        function cancelJob(jobId) {
            const button = document.getElementById("cancelButton");
            const statusText = document.getElementById("cancelStatus");

            button.disabled = true;
            statusText.textContent = "Attempting to cancel...";

            fetch(`/cancel/${jobId}`, { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    statusText.textContent = data.message || "Cancelled.";
                })
                .catch(err => {
                    statusText.textContent = "Cancellation failed. Try again.";
                    button.disabled = false;
                });
        }
    </script>
</head>
<body>
    <h1>Status for Job ID: {{ job_id }}</h1>

    <p><strong>Latest status:</strong> {{ state }}</p>

    {% if progress %}
        {% set percent = (progress.current / progress.total * 100) | round(0, 'floor') %}
        <div class="progress-container">
            <div class="progress-bar" style="width: {{ percent }}%;">{{ percent }}%</div>
        </div>
        <p><strong>Progress:</strong> {{ progress.current }} / {{ progress.total }} segments</p>
    {% endif %}

    {% if not done and not error and "Cancelled" not in state %}
        <button id="cancelButton" onclick="cancelJob('{{ job_id }}')">Cancel Transcription</button>
        <div id="cancelStatus"></div>
    {% endif %}

    <h3>Live Log</h3>
	<p><em>Log length: {{ log | length }} characters</em></p>
    <pre id="log">{{ log | safe }}</pre>

    {% if done %}
        <a href="{{ download_url }}">Download Transcript</a>
    {% elif error %}
        <p style="color: red;">An error occurred.</p>
    {% else %}
        <p>Still processing... This page refreshes every 5 seconds.</p>
    {% endif %}
</body>
</html>
