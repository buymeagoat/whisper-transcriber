=====Prompt
=====TASK=====
Audit the logic inside `whisper_build.sh` to ensure that every documented switch:
  - Has a corresponding logic block
  - Follows the intended behavior for that switch
  - Logs its status and execution path
  - Fails gracefully if prerequisites are missing
  - Matches the help text and documentation descriptions

=====CONSTRAINTS=====
- The script must correctly support:
  - --full (default): full online build
  - --offline: build only from pre-cached assets
  - --update: refresh dependencies and conditionally rebuild
  - --frontend-only: build only frontend Docker layers
  - --validate-only: run validation and exit
  - --docker-cleanup: remove stale Docker layers
  - --purge-cache: delete cache before staging
  - --verify-sources: test connectivity to mirrors
  - --help: show help and exit

- All cases must:
  - Print clear log messages indicating the mode selected
  - Avoid unintentional overlap between modes
  - Exit with non-zero code on failure
  - Honor CACHE_DIR and WSL detection

=====OBJECTIVE=====
Validate that `whisper_build.sh` is internally consistent, correctly maps switches to actions, and adheres to all declared behavior in documentation.

=====SCOPE=====
- scripts/whisper_build.sh

=====OUTPUT FORMAT=====
- ‚úÖ Report per switch: Present? Implemented? Safe? Logged?
- ‚úÖ Note missing, inconsistent, or unlogged behaviors
- ‚úÖ Recommend patches if required

üëâ Use **Ask Codex** to run this audit.

=====Codex Response

whisper_build.sh switch audit

Switch	Present?	Implemented?	Logged?	Notes
--full	‚úÖ	Executes download_dependencies then docker_build for a complete build	‚úÖ uses log_step "STAGING"	Behavior matches documentation.
--offline	‚úÖ	Runs verify_cache_integrity before invoking docker_build	‚úÖ logs OFFLINE VERIFY	Calls verify_cache_integrity again inside docker_build (duplicate). Relies on Node being preinstalled.
--update	‚úÖ	Same flow as --full (downloads and builds all)	‚úÖ logs UPDATE	Docs describe ‚Äúrebuild changed components only‚Äù, but script does not implement incremental behavior.
--frontend-only	‚úÖ	Runs full image build including API/worker via docker_build_frontend	‚úÖ logs FRONTEND ONLY	Documentation states ‚Äúbuild just the React UI‚Äù but implementation still rebuilds backend layers.
--validate-only	‚úÖ	Calls run_validations and exits early	‚úÖ logs VALIDATION	Behavior matches docs.
--docker-cleanup	‚úÖ	Prunes Docker images/builders when flag set	‚ö†Ô∏è No log output for cleanup action	Consider adding log_step "CLEANUP" for visibility.
--purge-cache	‚úÖ	Deletes $CACHE_DIR before staging deps	‚úÖ prints ‚ÄúPurging cache at ...‚Äù	Works as documented.
--verify-sources	‚úÖ	Runs connectivity tests via check_download_sources before build or validation	‚úÖ logs VERIFY SOURCES	Matches docs.
--help	‚úÖ	Displays help text and exits early	‚úÖ	Consistent with documentation.
Additional Observations

Help text lists all switches and matches documentation.

Cache path honors WSL detection through set_cache_dir.

Error trap prints a line number and points to the log file.

check_env.sh is executed before logging is redirected, so its output is not captured in whisper_build.log.

Issues & Recommendations

--update inconsistent with documentation. Script performs a full rebuild instead of ‚Äúrebuild changed components only.‚Äù Either adjust documentation or implement selective rebuild logic.

Suggested task
Clarify --update behavior or implement incremental rebuild

Start task
--frontend-only builds more than the frontend. Documentation promises ‚Äúbuild just the React UI,‚Äù but the script still rebuilds backend images.

Suggested task
Align --frontend-only with documentation

Start task
No explicit logging for Docker cleanup.

Suggested task
Add logging to docker_cleanup

Start task
Multiple mode flags silently overwrite each other.

Suggested task
Detect conflicting build modes

Start task
check_env.sh output not logged.

Suggested task
Log check_env output

Start task
Overall, most switches are implemented and logged, but the --update and --frontend-only behaviors do not match the help text, Docker cleanup lacks logging, conflicting flags aren‚Äôt detected, and some initialization output is missed in the log file. Addressing these issues will make the script consistent with its documentation and improve usability.